(-> (unify (from :part [#:xt{:id p} p-name]) (where (like p-name "%green%")) (from :orders [#:xt{:id o} o-orderdate]) (from :lineitem [{:l-orderkey o, :l-suppkey s, :l-partkey p} l-quantity l-extendedprice l-discount]) (from :partsupp [{:ps-partkey p, :ps-suppkey s} ps-supplycost]) (from :supplier [{:xt/id s, :s-nationkey n}]) (from :nation [{:xt/id n, :n-name nation}])) (with {:o-year (extract "YEAR" o-orderdate)}) (aggregate nation o-year {:sum-profit (sum (- (* l-extendedprice (- 1 l-discount)) (* ps-supplycost l-quantity)))}))